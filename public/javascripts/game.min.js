var Action,Brave,Game,Item,ItemCreator,MoveAction,Notifier,SearchAction,SharedItemCreator,Spot,Trifolium,WaitAction,itemDict,settings,_ref,_ref2,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},__slice=Array.prototype.slice,__bind=function(a,b){return function(){return a.apply(b,arguments)}};Notifier=function(){function a(){var a;a=require("http").createServer(function(a,b){return b.writeHead(200,{"Content-Type":"text/plain"}),b.end("Trifolium game server is running.\n")}),this.io=require("socket.io").listen(a),a.listen(6262),this.io.sockets.on("connection",function(a){})}return a.prototype.notify=function(a,b){return this.io.sockets.emit(a,b)},a}(),exports.Notifier=Notifier,Action=function(){function a(){this.name=null,this.time==null&&(this.time=0)}return a.prototype.prepare=function(a){},a.prototype["do"]=function(a){return a.action=null,a.actionProcess=0,{isSucceed:!1}},a.prototype.after=function(a,b){var c;return b.prepare(a),a.action=b,a.destination=(c=b.to)!=null?c:a.spot},a}(),WaitAction=function(a){function b(a){this.time=a,b.__super__.constructor.apply(this,arguments),this.name="wait"}return __extends(b,a),b.prototype["do"]=function(a){return b.__super__["do"].call(this,a),this.after(a,a.spot.randomAction()),{isSucceed:!0}},b}(Action),MoveAction=function(a){function b(a,c){this.from=a,this.to=c,b.__super__.constructor.apply(this,arguments),this.name="move",this.time=this.from.distance(this.to)*100}return __extends(b,a),b.prototype["do"]=function(a){return b.__super__["do"].call(this,a),a.spot=this.to,this.after(a,this.to.randomAction()),{isSucceed:!0}},b}(Action),SearchAction=function(a){function b(a,c){this.time=a,this.treasureDict=c!=null?c:{},b.__super__.constructor.apply(this,arguments),this.name="search"}return __extends(b,a),b.prototype.probabilityMax=1e3,b.prototype["do"]=function(a){var c,d,e,f,g,h,i,j,k,l,m,n;b.__super__["do"].call(this,a),i=0,n=this.treasureDict;for(d in n)l=n[d],i+=l.probability;if(i>this.probabilityMax)return{isSucceed:!1,treasure:null};k=function(){var a,b;a=this.treasureDict,b=[];for(d in a)l=a[d],b.push(d);return b}.call(this).sort(function(a,b){return.5-Math.random()}),h=0,g=function(){var a,b,c;c=[];for(a=0,b=k.length;a<b;a++)d=k[a],c.push(h+=this.treasureDict[d].probability);return c}.call(this),f=Math.random()*this.probabilityMax;for(c=0,m=k.length;c<m;c++)d=k[c],(typeof j=="undefined"||j===null)&&f<g[c]&&(j=this.treasureDict[d].item);return e=null,j&&a.addItem(j)?e=!0:e=!1,this.after(a,a.spot.randomAction()),{isSucceed:e,treasure:j}},b}(Action),typeof exports!="undefined"&&exports!==null&&(exports.Action=Action),typeof exports!="undefined"&&exports!==null&&(exports.WaitAction=WaitAction),typeof exports!="undefined"&&exports!==null&&(exports.MoveAction=MoveAction),typeof exports!="undefined"&&exports!==null&&(exports.SearchAction=SearchAction),Brave=function(){function a(a,b,c){var d,e,f,g,h,i,j,k,l,m;this.name=a,c==null&&(c={}),this.lv=(d=c.lv)!=null?d:1,this.atk=(f=c.atk)!=null?f:1,this.matk=(g=c.matk)!=null?g:1,this.hp=(h=c.hp)!=null?h:10,this.mp=(i=c.mp)!=null?i:10,this.brave=(j=c.brave)!=null?j:50,this.faith=(k=c.faith)!=null?k:50,this.speed=(l=c.speed)!=null?l:3,this.gold=(m=c.gold)!=null?m:300,this.items=(e=c.items)!=null?e:[],this.action=null,this.actionProcess=0,this.spot=b,this.destination=b,this.eventDict={}}return a.prototype.on=function(a,b){return this.eventDict[a]=b,this},a.prototype.emit=function(){var a,b,c;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],(c=this.eventDict[b])!=null?c.apply(this,a):void 0},a.prototype.tick=function(){var a,b;if(this.action!=null){this.actionProcess+=this.action.time>0?this.speed/this.action.time:1;if(this.actionProcess>=1)return a=this.action,b=this.action["do"](this),this.emit("completeAction",this,a,b)}},a.prototype.addItem=function(a){return this.items.length<10?(this.items.push(a),!0):!1},a.prototype.removeItem=function(a){var b;return this.items=function(){var c,d,e,f;e=this.items,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b!==a&&f.push(b);return f}.call(this)},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Brave=Brave),typeof require!="undefined"&&require!==null&&(itemDict=require("../../settings").itemDict),Item=function(){function a(a,b){var c;this.itemId=a,this.name=b,c=new Date,this.id=""+c.getTime()+c.getMilliseconds()+this.itemId+this.name}return a}(),ItemCreator=function(){function a(a){this.itemDict=a}return a.prototype.createItem=function(a,b){return b==null&&(b=null),this.itemDict[a]!=null?new Item(a,b!=null?b:this.itemDict[a].name):null},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Item=Item),typeof exports!="undefined"&&exports!==null&&(exports.ItemCreator=ItemCreator),typeof exports!="undefined"&&exports!==null&&(exports.SharedItemCreator=new ItemCreator(itemDict)),typeof require!="undefined"&&require!==null&&(_ref=require("./action"),Action=_ref.Action,WaitAction=_ref.WaitAction,MoveAction=_ref.MoveAction,SearchAction=_ref.SearchAction,SharedItemCreator=require("./item").SharedItemCreator),Spot=function(){function a(a,b,c,d){this.name=a,this.posX=b,this.posY=c,d==null&&(d=[]),this.actions=this.makeActions(d)}return a.prototype.randomAction=function(){var a;return a=Math.floor(Math.random()*this.actions.length),this.actions[a]},a.prototype.distance=function(a){return Math.sqrt(Math.pow(this.posX-a.posX,2)+Math.pow(this.posY-a.posY,2))},a.prototype.makeActions=function(a){var b,c,d,e,f,g,h,i,j,k,l;d=[];if(a!=null)for(h=0,j=a.length;h<j;h++){c=a[h],b=null;switch(c.type){case"wait":b=new WaitAction(c.time);break;case"search":f={},l=c.treasures;for(i=0,k=l.length;i<k;i++)g=l[i],e=SharedItemCreator.createItem(g.itemId,g.name),f[e.id]={item:e,probability:g.probability};b=new SearchAction(c.time,f)}b!=null&&d.push(b)}return d},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Spot=Spot),typeof require!="undefined"&&require!==null&&(Brave=require("./trifolium/brave").Brave,Spot=require("./trifolium/spot").Spot,_ref2=require("./trifolium/action"),Action=_ref2.Action,WaitAction=_ref2.WaitAction,MoveAction=_ref2.MoveAction,SearchAction=_ref2.SearchAction),Trifolium=function(){function a(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P;r=a.spotInfoList,k=a.routeInfoList,m=a.spawnSpotName,d=a.braveNameDictionary,i=a.numBraves,this.tickInterval=a.tickInterval,this.spotList=function(){var a,b,c;c=[];for(a=0,b=r.length;a<b;a++)q=r[a],c.push(new Spot(q.name,q.posX,q.posY,q.actions));return c}(),this.routeList=[],h=[];for(t=0,x=k.length;t<x;t++)j=k[t],o=this.spotForName(j[0]),p=this.spotForName(j[1]),h.push(new MoveAction(o,p)),h.push(new MoveAction(p,o)),this.routeList.push([o,p]);l=this.spotForName(m),J=this.spotList;for(u=0,y=J.length;u<y;u++){n=J[u];for(v=0,z=h.length;v<z;v++)g=h[v],g.from===n&&n.actions.push(g)}K=[d.prefixes,d.terms];for(w=0,A=K.length;w<A;w++){e=K[w];for(F=0,B=e.length;F<B;F++)s=e[F],((L=this.braveNamePrefixes)!=null?L:this.braveNamePrefixes=[]).push(s)}M=[d.suffixes,d.terms];for(G=0,C=M.length;G<C;G++){e=M[G];for(H=0,D=e.length;H<D;H++)s=e[H],((N=this.braveNameSuffixes)!=null?N:this.braveNameSuffixes=[]).push(s)}this.braveList=function(){var a;a=[];for(f=0;0<=i?f<i:f>i;0<=i?f++:f--)a.push(new Brave(this.makeBraveName(d),l,{speed:Math.floor(Math.random()*50)+20}));return a}.call(this),O=this.braveList;for(I=0,E=O.length;I<E;I++)c=O[I],b=c.spot.randomAction(),b.prepare(c),c.action=b,c.destination=(P=b.to)!=null?P:c.spot}return a.prototype.start=function(){var a,b=this;return this.count=0,a=setInterval(function(){return b.tick(),b.count++},this.tickInterval)},a.prototype.tick=function(){var a,b,c,d,e;d=this.braveList,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.tick());return e},a.prototype.makeBraveName=function(){var a,b;return a=parseInt(Math.random()*this.braveNamePrefixes.length),b=parseInt(Math.random()*this.braveNameSuffixes.length),""+this.braveNamePrefixes[a]+this.braveNameSuffixes[b]},a.prototype.spotForName=function(a){var b;return function(){var c,d,e,f;e=this.spotList,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b.name===a&&f.push(b);return f}.call(this)[0]},a.prototype.braveForName=function(a){var b;return function(){var c,d,e,f;e=this.braveList,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b.name===a&&f.push(b);return f}.call(this)[0]},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Trifolium=Trifolium),settings={tickInterval:30,spawnSpotName:"ちくわ城",spotInfoList:[{name:"こんぶシティー",posX:20,posY:-60,actions:[{type:"wait",time:3e3}]},{name:"もずくタウン",posX:-100,posY:-20,actions:[{type:"wait",time:3e3}]},{name:"わかめビレッジ",posX:20,posY:40,actions:[{type:"wait",time:3e3}]},{name:"なめこの洞窟",posX:120,posY:-80,actions:[{type:"wait",time:3e3},{type:"search",time:5e3,treasures:[{itemId:1,probability:500},{itemId:2,probability:100}]}]},{name:"たけのこ山",posX:-60,posY:-80,actions:[{type:"wait",time:3e3}]},{name:"かまぼこの迷宮",posX:-80,posY:60,actions:[{type:"wait",time:3e3}]},{name:"ちくわ城",posX:-40,posY:0,actions:[{type:"wait",time:3e3}]},{name:"たまねぎ寺院",posX:60,posY:-20,actions:[{type:"wait",time:3e3}]}],routeInfoList:[["こんぶシティー","たけのこ山"],["こんぶシティー","ちくわ城"],["こんぶシティー","たまねぎ寺院"],["もずくタウン","たけのこ山"],["もずくタウン","ちくわ城"],["わかめビレッジ","ちくわ城"],["わかめビレッジ","たまねぎ寺院"],["なめこの洞窟","たまねぎ寺院"],["かまぼこの迷宮","ちくわ城"]],numBraves:12,braveNameDictionary:{terms:["ポチ","タマ","ヒロ","チン","ペロ","ヒコ","テル","ユキ","トロ","リン","ポコ","タラ","ナリ","イチ","ユウ","ヨシ","オリ","タケ","マサ","タカ","ナオ","スケ","ピヨ","フウ","ツネ","ノロ","ポロ","ポポ","トト","テロ","ピロ","ポン","ポワ","ヨネ","ウメ","ノリ","ロウ","ゾウ","ヤン","ハン","リィ","オウ","チィ","ケン","チヨ","リリ","ザム","ラム","ヒム","タキ","ザワ"],prefixes:[],suffixes:["ミ","カ","コ","リ","ヨ","エ","ノ","ッピ","ッチ","ッペ","ヲ","オ","シ","ス","ッス","ッツ","ト","ジ","ザ","ラ"]}},itemDict={1:{name:"きのこ"},2:{name:"いいきのこ"},3:{name:"ちくわ"},4:{name:"いいちくわ"},5:{name:"おにく"},6:{name:"いいおにく"},10:{name:"竹の槍"}},typeof exports!="undefined"&&exports!==null&&(exports.settings=settings),typeof exports!="undefined"&&exports!==null&&(exports.itemDict=itemDict),$(function(){var a;return SharedItemCreator=new ItemCreator(itemDict),a=new Game(580,450),a.start()}),Game=function(){function a(a,b){this.width=a,this.height=b,this.debugMatrix=__bind(this.debugMatrix,this),this.simulator=new Trifolium(settings),this.canvas=new Canvas($("#main-screen").get(0),this.width,this.height),this.infoLayer=new CanvasNode,this.mapScale=2,this.selectedBrave=null,this.logMax=6}return a.prototype.appendRoute=function(a){var b,c;return b="rgba(0, 255, 0, 0.2)",c=new Line(this.canvas.width/2+a[0].posX*this.mapScale,this.canvas.height/2+a[0].posY*this.mapScale,this.canvas.width/2+a[1].posX*this.mapScale,this.canvas.height/2+a[1].posY*this.mapScale,{stroke:b,strokeWidth:10*this.mapScale,lineCap:"round"}),this.canvas.append(c)},a.prototype.appendSpot=function(a){var b;return b=new Circle(10*this.mapScale,{id:a.name,x:this.canvas.width/2+a.posX*this.mapScale,y:this.canvas.height/2+a.posY*this.mapScale,stroke:"rgba(0, 0, 255, 1.0)",strokeWidth:this.mapScale,endAngle:Math.PI*2}),this.canvas.append(b)},a.prototype.appendBrave=function(a){var b,c,d,e,f=this;return c=new CanvasNode({id:a.name,x:this.bravePosX(a),y:this.bravePosY(a),addedActionEffect:!1}),c.addFrameListener(function(b,d){var e;c.x=f.bravePosX(a),c.y=f.bravePosY(a);if(a===f.selectedBrave)return e=(a.actionProcess*100).toFixed(1),$("#brave-actionProcess-bar").text(""+e+"%"),$("#brave-actionProcess-bar").css("width",""+e+"%")}),c.addEventListener("mousedown",function(b){return f.selectedBrave=a,f.displayBraveInfo(a)}),d="hsla("+parseInt(Math.random()*360)+", 70%, 50%, 1.0)",e=new Circle(2*this.mapScale,{x:0,y:-2*this.mapScale,fill:d,endAngle:Math.PI*2}),b=new Rectangle(4*this.mapScale,4*this.mapScale,{x:-2*this.mapScale,y:0,fill:d}),c.append(e),c.append(b),this.canvas.append(c),a.on("completeAction",function(a,b,d){var e,g,h;g=40,h=800,e=new Circle(1*f.mapScale,{x:0,y:0,stroke:"rgba(33, 66, 255, 0.8)",strokeWidth:f.mapScale,fill:"rgba(33, 66, 255, 0.5)",endAngle:Math.PI*2,opacity:1}),e.addFrameListener(function(a,b){b>h&&e.removeSelf,e.radius+=b/h*g,e.opacity=(g-e.radius)/g;if(e.radius>g)return e.removeSelf(),c.addedActionEffect=!1}),c.addedActionEffect||(c.append(e),c.addedActionEffect=!0),a===f.selectedBrave&&($("#brave-position-value").text(""+a.spot.name),$("#brave-action-value").text(""+a.action.name),b.name==="search"&&d.isSucceed&&d.treasure&&$("#brave-item-table tbody").append($("<tr><td></td><td>"+d.treasure.name+"</td></tr>")));switch(b.name){case"move":return f.log("勇者"+f.logBraveName(a.name)+" が "+f.logSpotName(b.to.name)+" に到着しました");case"wait":return f.log("勇者"+f.logBraveName(a.name)+" はぼーっとしていた");case"search":return d.isSucceed?f.log("勇者"+f.logBraveName(a.name)+" は "+f.logItemName(d.treasure.name)+" を手に入れた!"):b.treasure?f.log("勇者"+f.logBraveName(a.name)+" は "+f.logItemName(d.treasure.name)+" を見つけたが、これ以上アイテムを持てないのであきらめた…"):f.log("勇者"+f.logBraveName(a.name)+" はアイテムを見つけられなかった…");default:return f.log("unknown event - "+b.name)}})},a.prototype.displayBraveInfo=function(a){var b,c,d,e,f,g,h,i,j;d=["name","lv","atk","matk","hp","mp","brave","faith","speed"];for(e=0,g=d.length;e<g;e++)c=d[e],$("#brave-"+c+"-value").text(a[c]);$("#brave-position-value").text(""+a.spot.name),$("#brave-action-value").text(""+a.action.name),$("#brave-item-table tbody").empty(),i=a.items,j=[];for(f=0,h=i.length;f<h;f++)b=i[f],j.push($("#brave-item-table tbody").append($("<tr><td></td><td>"+b.name+"</td></tr>")));return j},a.prototype.bravePosX=function(a){return this.canvas.width/2+(a.spot.posX+(a.destination.posX-a.spot.posX)*a.actionProcess)*this.mapScale},a.prototype.bravePosY=function(a){return this.canvas.height/2+(a.spot.posY+(a.destination.posY-a.spot.posY)*a.actionProcess)*this.mapScale},a.prototype.prepareDisplayObjects=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=this;l=this.simulator.routeList;for(f=0,i=l.length;f<i;f++)c=l[f],this.appendRoute(c);m=this.simulator.spotList;for(g=0,j=m.length;g<j;g++)e=m[g],this.appendSpot(e);n=this.simulator.braveList;for(h=0,k=n.length;h<k;h++)a=n[h],this.appendBrave(a);return this.debugMatrix(),b=16*this.mapScale,d=new Rectangle(b,b,{rx:4,ry:4,x:-b,y:-b,fill:"rgba(255, 128, 0, 0.3)",stroke:"rgba(255, 128, 0, 0.5)",strokeWidth:this.mapScale,endAngle:Math.PI*2}),d.addFrameListener(function(a,c){if(o.selectedBrave)return d.x=o.bravePosX(o.selectedBrave)-b/2,d.y=o.bravePosY(o.selectedBrave)-b/2}),this.canvas.append(d),this.infoLayer.append(new ElementNode(E("div",{id:"log"}),{valign:"bottom",y:this.height})),this.canvas.append(this.infoLayer)},a.prototype.start=function(){return this.prepareDisplayObjects(),this.simulator.start()},a.prototype.log=function(a){return this.logMax<=$("div#log").children().length&&$("div#log").children(":first").remove(),$("div#log").append($("<div class='logItem'>"+a+"</div>"))},a.prototype.logBraveName=function(a){return"<span class='log-brave-name'>"+a+"</span>"},a.prototype.logSpotName=function(a){return"<span class='log-spot-name'>"+a+"</span>"},a.prototype.logItemName=function(a){return"<span class='log-item-name'>"+a+"</span>"},a.prototype.debugMatrix=function(){var a,b,c,d,e,f,g,h,i;d=10*this.mapScale,e="rgba(0, 0, 255, 0.1)",a="rgba(0, 0, 255, 0.5)",b=this.canvas.width%d/2,c=this.canvas.height%d/2;for(g=0,h=this.canvas.height/d;0<=h?g<h:g>h;0<=h?g++:g--)g!==this.canvas.height/2/d&&this.canvas.append(new Line(0,g*d+c,this.canvas.width,g*d+c,{stroke:e}));for(f=0,i=this.canvas.width/d;0<=i?f<i:f>i;0<=i?f++:f--)f!==this.canvas.width/2/d&&this.canvas.append(new Line(f*d+b,0,f*d+b,this.canvas.height,{stroke:e}));return this.canvas.append(new Line(0,this.canvas.height/2,this.canvas.width,this.canvas.height/2,{stroke:a})),this.canvas.append(new Line(this.canvas.width/2,0,this.canvas.width/2,this.canvas.height,{stroke:a}))},a}();