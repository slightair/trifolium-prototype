var ActionInfo,BraveInfo,Game,ItemInfo,Receiver,SpotInfo,Trifolium,config,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__slice=Array.prototype.slice;config={websocketOptions:{mode:"socket.io",host:"http://localhost:6262"}},ActionInfo=function(){function a(a){var b,c,d,e;this.name=(d=a.name)!=null?d:"unknown",this.time=(e=a.time)!=null?e:0,this.optionalInfo={};for(c in a)b=a[c],c!=="name"&&c!=="time"&&(this.optionalInfo[c]=b)}return a}(),typeof exports!="undefined"&&exports!==null&&(exports.ActionInfo=ActionInfo),BraveInfo=function(){function a(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;this.id=(b=a.id)!=null?b:"unknown",this.name=(j=a.name)!=null?j:"unknown",this.lv=(k=a.lv)!=null?k:0,this.atk=(l=a.atk)!=null?l:0,this.matk=(m=a.matk)!=null?m:0,this.hp=(n=a.hp)!=null?n:0,this.mp=(o=a.mp)!=null?o:0,this.brave=(p=a.brave)!=null?p:0,this.faith=(q=a.faith)!=null?q:0,this.speed=(c=a.speed)!=null?c:0,this.gold=(d=a.gold)!=null?d:0,this.items=(e=a.items)!=null?e:[],this.action=(f=a.action)!=null?f:null,this.actionProcess=(g=a.actionProcess)!=null?g:0,this.spot=(h=a.spot)!=null?h:null,this.destination=(i=a.destination)!=null?i:null}return a.prototype.addItem=function(a){return this.items.push(a)},a.prototype.updateActionProcess=function(a){if(this.action!=null&&this.actionProcess<1){this.actionProcess+=this.action.time>0?this.speed*a/this.action.time:1;if(this.actionProcess>1)return this.actionProcess=1}},a.prototype.updateAction=function(a){return this.action=a,this.actionProcess=0},a}(),typeof exports!="undefined"&&exports!==null&&(exports.BraveInfo=BraveInfo),ItemInfo=function(){function a(a){var b,c,d;this.id=(b=a.id)!=null?b:"unknown",this.name=(c=a.name)!=null?c:"unknown",this.itemId=(d=a.itemId)!=null?d:0}return a}(),typeof exports!="undefined"&&exports!==null&&(exports.ItemInfo=ItemInfo),Receiver=function(){function a(a){var b;this.mode=a!=null?a.mode:void 0;switch(this.mode){case"pusher":1;break;case"socket.io":typeof require!="undefined"&&require!==null?(b=require("socket.io-client"),this.socket=b.connect(a.host)):this.socket=io.connect(a.host);break;default:console.log("receiver do nothing.")}}return a.prototype.bind=function(a,b){var c;switch(this.mode){case"pusher":1;break;case"socket.io":(c=this.socket)!=null&&c.on(a,b);break;default:console.log("bind "+a)}return this},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Receiver=Receiver),SpotInfo=function(){function a(a){var b,c,d,e;this.id=(b=a.id)!=null?b:"unknown",this.name=(c=a.name)!=null?c:"unknown",this.posX=(d=a.posX)!=null?d:0,this.posY=(e=a.posY)!=null?e:0}return a}(),typeof exports!="undefined"&&exports!==null&&(exports.SpotInfo=SpotInfo),typeof require!="undefined"&&require!==null&&(Receiver=require("./receiver").Receiver,BraveInfo=require("./braveInfo").BraveInfo,ActionInfo=require("./actionInfo").ActionInfo,ItemInfo=require("./itemInfo").ItemInfo,SpotInfo=require("./spotInfo").SpotInfo),Trifolium=function(){function a(a){this.receiveBraveCompleteAction=__bind(this.receiveBraveCompleteAction,this),this.receiveRestoreGameStatus=__bind(this.receiveRestoreGameStatus,this);var b;b=new Receiver(a.websocketOptions),this.spotList=[],this.routeList=[],this.braveList=[],this.eventDict={},b.bind("restoreGameStatus",this.receiveRestoreGameStatus),b.bind("braveCompleteAction",this.receiveBraveCompleteAction)}return a.prototype.spotForName=function(a){var b;return function(){var c,d,e,f;e=this.spotList,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b.name===a&&f.push(b);return f}.call(this)[0]},a.prototype.spotForId=function(a){var b;return function(){var c,d,e,f;e=this.spotList,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b.id===a&&f.push(b);return f}.call(this)[0]},a.prototype.braveForName=function(a){var b;return function(){var c,d,e,f;e=this.braveList,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b.name===a&&f.push(b);return f}.call(this)[0]},a.prototype.braveForId=function(a){var b;return function(){var c,d,e,f;e=this.braveList,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b.id===a&&f.push(b);return f}.call(this)[0]},a.prototype.on=function(a,b){return this.eventDict[a]=b,this},a.prototype.emit=function(){var a,b,c;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],(c=this.eventDict[b])!=null?c.apply(this,a):void 0},a.prototype.restoreGameStatus=function(a){var b,c,d,e,f=this;return c=function(a){var b;return a.items=function(){var c,d,e,f;e=a.items,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(new ItemInfo(b));return f}(),a.action=new ActionInfo(a.action),a.spot=f.spotForId(a.spot),a.destination=f.spotForId(a.destination),a},this.tickInterval=a.tickInterval,this.spotList=function(){var b,c,d,f;d=a.spotList,f=[];for(b=0,c=d.length;b<c;b++)e=d[b],f.push(new SpotInfo(e));return f}(),this.braveList=function(){var d,e,f,g;f=a.braveList,g=[];for(d=0,e=f.length;d<e;d++)b=f[d],g.push(new BraveInfo(c(b)));return g}(),this.routeList=function(){var b,c,e,f;e=a.routeList,f=[];for(b=0,c=e.length;b<c;b++)d=e[b],f.push([this.spotForId(d[0]),this.spotForId(d[1])]);return f}.call(this)},a.prototype.receiveRestoreGameStatus=function(a){return this.restoreGameStatus(a),this.emit("restoreGameStatus")},a.prototype.receiveBraveCompleteAction=function(a){var b,c,d;return b=this.braveForId(a.brave),d=b.action,c=new ActionInfo(a.nextAction),b.spot=a.completeAction.name==="move"?this.spotForId(a.completeAction.to):b.spot,b.destination=a.nextAction.name==="move"?this.spotForId(a.nextAction.to):b.spot,a.completeAction.name==="search"&&a.result.isSucceed&&a.result.treasure&&b.addItem(new ItemInfo(a.result.treasure)),b.updateAction(c),this.emit("braveCompleteAction",b,d,a.result)},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Trifolium=Trifolium),$(function(){var a;return a=new Game(580,450)}),Game=function(){function a(a,b){var c=this;this.width=a,this.height=b,this.trifolium=new Trifolium(config),this.canvas=new Canvas($("#main-screen").get(0),this.width,this.height),this.infoLayer=new CanvasNode,this.mapScale=2,this.selectedBrave=null,this.braveObjects=[],this.logMax=6,this.trifolium.on("restoreGameStatus",function(){return c.prepareDisplayObjects()}),this.trifolium.on("braveCompleteAction",function(a,b,d){return c.braveCompleteAction(a,b,d)})}return a.prototype.appendRoute=function(a){var b,c;return b="#a8ff60",c=new Line(this.canvas.width/2+a[0].posX*this.mapScale,this.canvas.height/2+a[0].posY*this.mapScale,this.canvas.width/2+a[1].posX*this.mapScale,this.canvas.height/2+a[1].posY*this.mapScale,{stroke:b,strokeWidth:10*this.mapScale,lineCap:"round"}),this.canvas.append(c)},a.prototype.appendSpot=function(a){var b;return b=new Circle(10*this.mapScale,{id:a.id,x:this.canvas.width/2+a.posX*this.mapScale,y:this.canvas.height/2+a.posY*this.mapScale,stroke:"#0000ff",strokeWidth:this.mapScale,endAngle:Math.PI*2}),this.canvas.append(b)},a.prototype.appendBrave=function(a){var b,c,d,e,f=this;return c=new CanvasNode({id:a.id,x:this.bravePosX(a),y:this.bravePosY(a),addedActionEffect:!1}),c.addFrameListener(function(b,d){var e,g;c.x=f.bravePosX(a),c.y=f.bravePosY(a),g=d/f.trifolium.tickInterval,a.updateActionProcess(g);if(a===f.selectedBrave)return e=(a.actionProcess*100).toFixed(1),$("#brave-actionProcess-bar").text(""+e+"%"),$("#brave-actionProcess-bar").css("width",""+e+"%")}),c.addEventListener("mousedown",function(b){return f.selectedBrave=a,f.displayBraveInfo(a)}),d="hsl("+parseInt(Math.random()*360)+", 70%, 50%)",e=new Circle(2*this.mapScale,{x:0,y:-2*this.mapScale,fill:d,endAngle:Math.PI*2}),b=new Rectangle(4*this.mapScale,4*this.mapScale,{x:-2*this.mapScale,y:0,fill:d}),c.append(e),c.append(b),this.canvas.append(c),this.braveObjects.push(c)},a.prototype.braveCompleteAction=function(a,b,c){var d,e;e=this.braveObjectForId(a.id),e.append(this.actionEffect()),a===this.selectedBrave&&($("#brave-position-value").text(""+a.spot.name),$("#brave-action-value").text(""+a.action.name),b.name==="search"&&c.isSucceed&&c.treasure&&$("#brave-item-table tbody").append($("<tr><td></td><td>"+c.treasure.name+"</td></tr>")));switch(b.name){case"move":return d=this.trifolium.spotForId(b.optionalInfo.to),this.log("勇者"+this.logBraveName(a.name)+" が "+this.logSpotName(d.name)+" に到着しました");case"wait":return this.log("勇者"+this.logBraveName(a.name)+" はぼーっとしていた");case"search":return c.isSucceed?this.log("勇者"+this.logBraveName(a.name)+" は "+this.logItemName(c.treasure.name)+" を手に入れた!"):c.treasure?this.log("勇者"+this.logBraveName(a.name)+" は "+this.logItemName(c.treasure.name)+" を見つけたが、これ以上アイテムを持てないのであきらめた…"):this.log("勇者"+this.logBraveName(a.name)+" はアイテムを見つけられなかった…");default:return this.log("unknown event - "+b.name)}},a.prototype.actionEffect=function(){var a,b,c;return c=20,b=800,a=new Circle(1*this.mapScale,{x:0,y:0,fill:"#ffffb6",endAngle:Math.PI*2,opacity:1}),a.addFrameListener(function(a,d){var e;return this.startTime==null&&(this.startTime=a),e=(a-this.startTime)/b,this.scale=c*e,this.opacity=1-e}),a.after(b,function(){return this.removeSelf()}),a},a.prototype.displayBraveInfo=function(a){var b,c,d,e,f,g,h,i,j;d=["name","lv","atk","matk","hp","mp","brave","faith","speed"];for(e=0,g=d.length;e<g;e++)c=d[e],$("#brave-"+c+"-value").text(a[c]);$("#brave-position-value").text(""+a.spot.name),$("#brave-action-value").text(""+a.action.name),$("#brave-item-table tbody").empty(),i=a.items,j=[];for(f=0,h=i.length;f<h;f++)b=i[f],j.push($("#brave-item-table tbody").append($("<tr><td></td><td>"+b.name+"</td></tr>")));return j},a.prototype.bravePosX=function(a){return this.canvas.width/2+(a.spot.posX+(a.destination.posX-a.spot.posX)*a.actionProcess)*this.mapScale},a.prototype.bravePosY=function(a){return this.canvas.height/2+(a.spot.posY+(a.destination.posY-a.spot.posY)*a.actionProcess)*this.mapScale},a.prototype.braveObjectForId=function(a){var b;return function(){var c,d,e,f;e=this.braveObjects,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b.id===a&&f.push(b);return f}.call(this)[0]},a.prototype.prepareDisplayObjects=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=this;l=this.trifolium.routeList;for(f=0,i=l.length;f<i;f++)c=l[f],this.appendRoute(c);m=this.trifolium.spotList;for(g=0,j=m.length;g<j;g++)e=m[g],this.appendSpot(e);n=this.trifolium.braveList;for(h=0,k=n.length;h<k;h++)a=n[h],this.appendBrave(a);return b=16*this.mapScale,d=new Rectangle(b,b,{rx:4,ry:4,x:-b,y:-b,fill:"#ffb6b0",stroke:"#ff6c60",strokeWidth:this.mapScale,endAngle:Math.PI*2}),d.addFrameListener(function(a,c){if(o.selectedBrave)return d.x=o.bravePosX(o.selectedBrave)-b/2,d.y=o.bravePosY(o.selectedBrave)-b/2}),this.canvas.append(d),this.infoLayer.append(new ElementNode(E("div",{id:"log"}),{valign:"bottom",y:this.height})),this.canvas.append(this.infoLayer)},a.prototype.log=function(a){return this.logMax<=$("div#log").children().length&&$("div#log").children(":first").remove(),$("div#log").append($("<div class='logItem'>"+a+"</div>"))},a.prototype.logBraveName=function(a){return"<span class='log-brave-name'>"+a+"</span>"},a.prototype.logSpotName=function(a){return"<span class='log-spot-name'>"+a+"</span>"},a.prototype.logItemName=function(a){return"<span class='log-item-name'>"+a+"</span>"},a}();