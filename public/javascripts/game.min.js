var Action,Brave,Game,MoveAction,SearchAction,Spot,Trifolium,WaitAction,settings,_ref,_ref2,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},__bind=function(a,b){return function(){return a.apply(b,arguments)}};Action=function(){function a(){this.name=null,this.isSucceed=!1,this.time=0}return a.prototype.prepare=function(a){},a.prototype["do"]=function(a){return a.action=null,a.actionProcess=0,this.isSucceed=!0,a.doneAction(this)},a.prototype.after=function(a,b){var c;return b.prepare(a),a.action=b,a.destination=(c=b.to)!=null?c:a.spot},a}(),WaitAction=function(a){function b(a){b.__super__.constructor.apply(this,arguments),this.name="wait",this.time=a}return __extends(b,a),b.prototype["do"]=function(a){return b.__super__["do"].call(this,a),this.after(a,a.spot.randomAction()),this.isSucceed=!0},b}(Action),MoveAction=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments),this.name="move",this.from=a,this.to=c,this.time=a.distance(c)*100}return __extends(b,a),b.prototype["do"]=function(a){return b.__super__["do"].call(this,a),a.spot=this.to,this.after(a,this.to.randomAction()),this.isSucceed=!0},b}(Action),SearchAction=function(a){function b(a){b.__super__.constructor.apply(this,arguments),this.name="search",this.treasureDict=a,this.treasure=null,this.time=1e3}return __extends(b,a),b.prototype.probabilityMax=1e3,b.prototype["do"]=function(a){var c,d,e,f,g,h,i,j,k;b.__super__["do"].call(this,a),g=0,k=this.treasureDict;for(h in k)f=k[h],g+=f;if(g>this.probabilityMax)return this.isSucceed=!1;i=function(){var a,b;a=this.treasureDict,b=[];for(h in a)f=a[h],b.push(h);return b}.call(this).sort(function(a,b){return.5-Math.random()}),f=0,e=function(){var a,b,c;c=[];for(a=0,b=i.length;a<b;a++)h=i[a],c.push(f+=this.treasureDict[h]);return c}.call(this),d=Math.random()*this.probabilityMax;for(c=0,j=i.length;c<j;c++)h=i[c],this.treasure==null&&d<e[c]&&(this.treasure=h);return this.isSucceed=this.treasure!=null},b}(Action),typeof exports!="undefined"&&exports!==null&&(exports.Action=Action),typeof exports!="undefined"&&exports!==null&&(exports.WaitAction=WaitAction),typeof exports!="undefined"&&exports!==null&&(exports.MoveAction=MoveAction),typeof exports!="undefined"&&exports!==null&&(exports.SearchAction=SearchAction),Brave=function(){function a(a,b,c){var d,e,f,g,h,i,j,k;c==null&&(c={}),this.listeners=[],this.name=a,this.lv=(d=c.lv)!=null?d:1,this.atk=(e=c.atk)!=null?e:1,this.matk=(f=c.matk)!=null?f:1,this.hp=(g=c.hp)!=null?g:10,this.mp=(h=c.mp)!=null?h:10,this.brave=(i=c.brave)!=null?i:50,this.faith=(j=c.faith)!=null?j:50,this.speed=(k=c.speed)!=null?k:3,this.action=null,this.actionProcess=0,this.spot=b,this.destination=b}return a.prototype.tick=function(){var a;if(this.action!=null){this.actionProcess+=this.action.time>0?this.speed/this.action.time:1;if(this.actionProcess>=1)return a=this.action["do"](this)}},a.prototype.addListener=function(a){return this.listeners.push(a)},a.prototype.removeListener=function(a){var b;return this.listeners=function(){var c,d,e,f;e=this.listeners,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b!==a&&f.push(b);return f}.call(this)},a.prototype.doneAction=function(a){var b,c,d,e,f;e=this.listeners,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b.completeBraveAction(this,a));return f},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Brave=Brave),typeof require!="undefined"&&require!==null&&(_ref=require("./action"),Action=_ref.Action,WaitAction=_ref.WaitAction,MoveAction=_ref.MoveAction,SearchAction=_ref.SearchAction),Spot=function(){function a(a,b,c,d){d==null&&(d=[]),this.name=a,this.posX=b,this.posY=c,this.actions=this.makeActions(d)}return a.prototype.randomAction=function(){var a;return a=Math.floor(Math.random()*this.actions.length),this.actions[a]},a.prototype.distance=function(a){return Math.sqrt(Math.pow(this.posX-a.posX,2)+Math.pow(this.posY-a.posY,2))},a.prototype.makeActions=function(a){var b,c,d,e,f;d=[];if(a!=null)for(e=0,f=a.length;e<f;e++){c=a[e],b=null;switch(c.type){case"wait":b=new WaitAction(c.time)}b!=null&&d.push(b)}return d},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Spot=Spot),typeof require!="undefined"&&require!==null&&(Brave=require("./trifolium/brave").Brave,Spot=require("./trifolium/spot").Spot,_ref2=require("./trifolium/action"),Action=_ref2.Action,WaitAction=_ref2.WaitAction,MoveAction=_ref2.MoveAction,SearchAction=_ref2.SearchAction),Trifolium=function(){function a(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;this.spotList=function(){var b,c,d,e;d=a.spotList,e=[];for(b=0,c=d.length;b<c;b++)l=d[b],e.push(new Spot(l.name,l.posX,l.posY,l.actions));return e}(),this.routeList=[],e=[],u=a.routeList;for(m=0,q=u.length;m<q;m++)g=u[m],j=this.spotForName(g[0]),k=this.spotForName(g[1]),e.push(new MoveAction(j,k)),e.push(new MoveAction(k,j)),this.routeList.push([j,k]);h=null,v=this.spotList;for(n=0,r=v.length;n<r;n++){i=v[n];for(o=0,s=e.length;o<s;o++)d=e[o],d.from===i&&i.actions.push(d);i.name===a.spawnSpot&&(h=i)}this.braveList=function(){var b,c,d,e;d=a.braveNames,e=[];for(b=0,c=d.length;b<c;b++)f=d[b],e.push(new Brave(f,h,{speed:Math.floor(Math.random()*50)+20}));return e}(),w=this.braveList;for(p=0,t=w.length;p<t;p++)c=w[p],c.addListener(this),b=c.spot.randomAction(),b.prepare(c),c.action=b,c.destination=(x=b.to)!=null?x:c.spot}return a.prototype.start=function(){var a,b=this;return this.count=0,a=setInterval(function(){return b.tick(),b.count++},30)},a.prototype.tick=function(){var a,b,c,d,e;d=this.braveList,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.tick());return e},a.prototype.completeBraveAction=function(a,b){switch(b.name){case"move":return console.log(""+a.name+" is arrived at "+b.to.name);case"wait":return console.log(""+a.name+" is waiting...")}},a.prototype.spotForName=function(a){var b;return function(){var c,d,e,f;e=this.spotList,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b.name===a&&f.push(b);return f}.call(this)[0]},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Trifolium=Trifolium),settings={spawnSpot:"castle",spotList:[{name:"townA",posX:20,posY:-60,actions:[{type:"wait",time:3e3}]},{name:"townB",posX:-100,posY:-20,actions:[{type:"wait",time:3e3}]},{name:"townC",posX:20,posY:40,actions:[{type:"wait",time:3e3}]},{name:"dungeonA",posX:120,posY:-80,actions:[{type:"wait",time:3e3}]},{name:"dungeonB",posX:-60,posY:-80,actions:[{type:"wait",time:3e3}]},{name:"dungeonC",posX:-80,posY:60,actions:[{type:"wait",time:3e3}]},{name:"castle",posX:-40,posY:0,actions:[{type:"wait",time:3e3}]},{name:"temple",posX:60,posY:-20,actions:[{type:"wait",time:3e3}]}],routeList:[["townA","dungeonB"],["townA","castle"],["townA","temple"],["townB","dungeonB"],["townB","castle"],["townC","castle"],["townC","temple"],["dungeonA","temple"],["dungeonC","castle"]],braveNames:["anderson","bob","clarisse","daniel","eric","fredelic","george","heinkel","iris","jennifer","kirby","leonard","michael","nick","orlando","pierre","qian","richard","sara","thomas","ulrich","veeder","walter","xavier","yakov","zach"]},typeof exports!="undefined"&&exports!==null&&(exports.settings=settings),$(function(){var a;return a=new Game,a.start()}),Game=function(){function a(){this.debugMatrix=__bind(this.debugMatrix,this);var a,b,c,d,e,f,g,h,i,j,k,l;this.simulator=new Trifolium(settings),this.canvas=new Canvas($("#main-screen").get(0),600,450),this.mapScale=2,j=this.simulator.routeList;for(d=0,g=j.length;d<g;d++)b=j[d],this.appendRoute(b);k=this.simulator.spotList;for(e=0,h=k.length;e<h;e++)c=k[e],this.appendSpot(c);l=this.simulator.braveList;for(f=0,i=l.length;f<i;f++)a=l[f],this.appendBrave(a);this.debugMatrix()}return a.prototype.appendRoute=function(a){var b,c;return b="rgba(0, 255, 0, 0.2)",c=new Line(this.canvas.width/2+a[0].posX*this.mapScale,this.canvas.height/2+a[0].posY*this.mapScale,this.canvas.width/2+a[1].posX*this.mapScale,this.canvas.height/2+a[1].posY*this.mapScale,{stroke:b,strokeWidth:20,lineCap:"round"}),this.canvas.append(c)},a.prototype.appendSpot=function(a){var b;return b=new Circle(10*this.mapScale,{id:a.name,x:this.canvas.width/2+a.posX*this.mapScale,y:this.canvas.height/2+a.posY*this.mapScale,stroke:"rgba(0, 0, 255, 1.0)",strokeWidth:3,endAngle:Math.PI*2}),this.canvas.append(b)},a.prototype.appendBrave=function(a){var b,c,d,e=this;return c=function(a){return e.canvas.width/2+(a.spot.posX+(a.destination.posX-a.spot.posX)*a.actionProcess)*e.mapScale},d=function(a){return e.canvas.height/2+(a.spot.posY+(a.destination.posY-a.spot.posY)*a.actionProcess)*e.mapScale},b=new Circle(3*this.mapScale,{id:a.name,x:c(a),y:d(a),fill:"red",endAngle:Math.PI*2}),b.addFrameListener(function(e,f){return b.x=c(a),b.y=d(a)}),b.addEventListener("mousedown",function(b){return e.displayBraveInfo(a)}),this.canvas.append(b)},a.prototype.displayBraveInfo=function(a){return $("#brave-name-value").text(a.name)},a.prototype.start=function(){return this.simulator.start()},a.prototype.debugMatrix=function(){var a,b,c,d,e,f,g;b=20,c="rgba(0, 0, 255, 0.1)",a="rgba(0, 0, 255, 0.5)";for(e=1,f=this.canvas.height/b;1<=f?e<f:e>f;1<=f?e++:e--)e!==this.canvas.height/2/b&&this.canvas.append(new Line(0,e*b,this.canvas.width,e*b,{stroke:c}));for(d=1,g=this.canvas.width/b;1<=g?d<g:d>g;1<=g?d++:d--)d!==this.canvas.width/2/b&&this.canvas.append(new Line(d*b,0,d*b,this.canvas.height,{stroke:c}));return this.canvas.append(new Line(0,this.canvas.height/2,this.canvas.width,this.canvas.height/2,{stroke:a})),this.canvas.append(new Line(this.canvas.width/2,0,this.canvas.width/2,this.canvas.height,{stroke:a}))},a}();