var Game,itemDict,settings,__bind=function(a,b){return function(){return a.apply(b,arguments)}};settings={tickInterval:30,spawnSpotName:"ちくわ城",spotInfoList:[{name:"こんぶシティー",posX:20,posY:-60,actions:[{type:"wait",time:3e3}]},{name:"もずくタウン",posX:-100,posY:-20,actions:[{type:"wait",time:3e3}]},{name:"わかめビレッジ",posX:20,posY:40,actions:[{type:"wait",time:3e3}]},{name:"なめこの洞窟",posX:120,posY:-80,actions:[{type:"wait",time:3e3},{type:"search",time:5e3,treasures:[{itemId:1,probability:500},{itemId:2,probability:100}]}]},{name:"たけのこ山",posX:-60,posY:-80,actions:[{type:"wait",time:3e3}]},{name:"かまぼこの迷宮",posX:-80,posY:60,actions:[{type:"wait",time:3e3}]},{name:"ちくわ城",posX:-40,posY:0,actions:[{type:"wait",time:3e3}]},{name:"たまねぎ寺院",posX:60,posY:-20,actions:[{type:"wait",time:3e3}]}],routeInfoList:[["こんぶシティー","たけのこ山"],["こんぶシティー","ちくわ城"],["こんぶシティー","たまねぎ寺院"],["もずくタウン","たけのこ山"],["もずくタウン","ちくわ城"],["わかめビレッジ","ちくわ城"],["わかめビレッジ","たまねぎ寺院"],["なめこの洞窟","たまねぎ寺院"],["かまぼこの迷宮","ちくわ城"]],numBraves:12,braveNameDictionary:{terms:["ポチ","タマ","ヒロ","チン","ペロ","ヒコ","テル","ユキ","トロ","リン","ポコ","タラ","ナリ","イチ","ユウ","ヨシ","オリ","タケ","マサ","タカ","ナオ","スケ","ピヨ","フウ","ツネ","ノロ","ポロ","ポポ","トト","テロ","ピロ","ポン","ポワ","ヨネ","ウメ","ノリ","ロウ","ゾウ","ヤン","ハン","リィ","オウ","チィ","ケン","チヨ","リリ","ザム","ラム","ヒム","タキ","ザワ"],prefixes:[],suffixes:["ミ","カ","コ","リ","ヨ","エ","ノ","ッピ","ッチ","ッペ","ヲ","オ","シ","ス","ッス","ッツ","ト","ジ","ザ","ラ"]}},itemDict={1:{name:"きのこ"},2:{name:"いいきのこ"},3:{name:"ちくわ"},4:{name:"いいちくわ"},5:{name:"おにく"},6:{name:"いいおにく"},10:{name:"竹の槍"}},typeof exports!="undefined"&&exports!==null&&(exports.settings=settings),typeof exports!="undefined"&&exports!==null&&(exports.itemDict=itemDict),$(function(){var a,b;return a=new ItemCreator(itemDict),b=new Game(580,450),b.start()}),Game=function(){function a(a,b){this.width=a,this.height=b,this.debugMatrix=__bind(this.debugMatrix,this),this.simulator=new Trifolium(settings),this.canvas=new Canvas($("#main-screen").get(0),this.width,this.height),this.infoLayer=new CanvasNode,this.mapScale=2,this.selectedBrave=null,this.logMax=6}return a.prototype.appendRoute=function(a){var b,c;return b="rgba(0, 255, 0, 0.2)",c=new Line(this.canvas.width/2+a[0].posX*this.mapScale,this.canvas.height/2+a[0].posY*this.mapScale,this.canvas.width/2+a[1].posX*this.mapScale,this.canvas.height/2+a[1].posY*this.mapScale,{stroke:b,strokeWidth:10*this.mapScale,lineCap:"round"}),this.canvas.append(c)},a.prototype.appendSpot=function(a){var b;return b=new Circle(10*this.mapScale,{id:a.name,x:this.canvas.width/2+a.posX*this.mapScale,y:this.canvas.height/2+a.posY*this.mapScale,stroke:"rgba(0, 0, 255, 1.0)",strokeWidth:this.mapScale,endAngle:Math.PI*2}),this.canvas.append(b)},a.prototype.appendBrave=function(a){var b,c,d,e,f=this;return c=new CanvasNode({id:a.name,x:this.bravePosX(a),y:this.bravePosY(a),addedActionEffect:!1}),c.addFrameListener(function(b,d){var e;c.x=f.bravePosX(a),c.y=f.bravePosY(a);if(a===f.selectedBrave)return e=(a.actionProcess*100).toFixed(1),$("#brave-actionProcess-bar").text(""+e+"%"),$("#brave-actionProcess-bar").css("width",""+e+"%")}),c.addEventListener("mousedown",function(b){return f.selectedBrave=a,f.displayBraveInfo(a)}),d="hsla("+parseInt(Math.random()*360)+", 70%, 50%, 1.0)",e=new Circle(2*this.mapScale,{x:0,y:-2*this.mapScale,fill:d,endAngle:Math.PI*2}),b=new Rectangle(4*this.mapScale,4*this.mapScale,{x:-2*this.mapScale,y:0,fill:d}),c.append(e),c.append(b),this.canvas.append(c),a.on("completeAction",function(a,b,d){var e,g,h;g=40,h=800,e=new Circle(1*f.mapScale,{x:0,y:0,stroke:"rgba(33, 66, 255, 0.8)",strokeWidth:f.mapScale,fill:"rgba(33, 66, 255, 0.5)",endAngle:Math.PI*2,opacity:1}),e.addFrameListener(function(a,b){b>h&&e.removeSelf,e.radius+=b/h*g,e.opacity=(g-e.radius)/g;if(e.radius>g)return e.removeSelf(),c.addedActionEffect=!1}),c.addedActionEffect||(c.append(e),c.addedActionEffect=!0),a===f.selectedBrave&&($("#brave-position-value").text(""+a.spot.name),$("#brave-action-value").text(""+a.action.name),b.name==="search"&&d.isSucceed&&d.treasure&&$("#brave-item-table tbody").append($("<tr><td></td><td>"+d.treasure.name+"</td></tr>")));switch(b.name){case"move":return f.log("勇者"+f.logBraveName(a.name)+" が "+f.logSpotName(b.to.name)+" に到着しました");case"wait":return f.log("勇者"+f.logBraveName(a.name)+" はぼーっとしていた");case"search":return d.isSucceed?f.log("勇者"+f.logBraveName(a.name)+" は "+f.logItemName(d.treasure.name)+" を手に入れた!"):b.treasure?f.log("勇者"+f.logBraveName(a.name)+" は "+f.logItemName(d.treasure.name)+" を見つけたが、これ以上アイテムを持てないのであきらめた…"):f.log("勇者"+f.logBraveName(a.name)+" はアイテムを見つけられなかった…");default:return f.log("unknown event - "+b.name)}})},a.prototype.displayBraveInfo=function(a){var b,c,d,e,f,g,h,i,j;d=["name","lv","atk","matk","hp","mp","brave","faith","speed"];for(e=0,g=d.length;e<g;e++)c=d[e],$("#brave-"+c+"-value").text(a[c]);$("#brave-position-value").text(""+a.spot.name),$("#brave-action-value").text(""+a.action.name),$("#brave-item-table tbody").empty(),i=a.items,j=[];for(f=0,h=i.length;f<h;f++)b=i[f],j.push($("#brave-item-table tbody").append($("<tr><td></td><td>"+b.name+"</td></tr>")));return j},a.prototype.bravePosX=function(a){return this.canvas.width/2+(a.spot.posX+(a.destination.posX-a.spot.posX)*a.actionProcess)*this.mapScale},a.prototype.bravePosY=function(a){return this.canvas.height/2+(a.spot.posY+(a.destination.posY-a.spot.posY)*a.actionProcess)*this.mapScale},a.prototype.prepareDisplayObjects=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=this;l=this.simulator.routeList;for(f=0,i=l.length;f<i;f++)c=l[f],this.appendRoute(c);m=this.simulator.spotList;for(g=0,j=m.length;g<j;g++)e=m[g],this.appendSpot(e);n=this.simulator.braveList;for(h=0,k=n.length;h<k;h++)a=n[h],this.appendBrave(a);return this.debugMatrix(),b=16*this.mapScale,d=new Rectangle(b,b,{rx:4,ry:4,x:-b,y:-b,fill:"rgba(255, 128, 0, 0.3)",stroke:"rgba(255, 128, 0, 0.5)",strokeWidth:this.mapScale,endAngle:Math.PI*2}),d.addFrameListener(function(a,c){if(o.selectedBrave)return d.x=o.bravePosX(o.selectedBrave)-b/2,d.y=o.bravePosY(o.selectedBrave)-b/2}),this.canvas.append(d),this.infoLayer.append(new ElementNode(E("div",{id:"log"}),{valign:"bottom",y:this.height})),this.canvas.append(this.infoLayer)},a.prototype.start=function(){return this.prepareDisplayObjects(),this.simulator.start()},a.prototype.log=function(a){return this.logMax<=$("div#log").children().length&&$("div#log").children(":first").remove(),$("div#log").append($("<div class='logItem'>"+a+"</div>"))},a.prototype.logBraveName=function(a){return"<span class='log-brave-name'>"+a+"</span>"},a.prototype.logSpotName=function(a){return"<span class='log-spot-name'>"+a+"</span>"},a.prototype.logItemName=function(a){return"<span class='log-item-name'>"+a+"</span>"},a.prototype.debugMatrix=function(){var a,b,c,d,e,f,g,h,i;d=10*this.mapScale,e="rgba(0, 0, 255, 0.1)",a="rgba(0, 0, 255, 0.5)",b=this.canvas.width%d/2,c=this.canvas.height%d/2;for(g=0,h=this.canvas.height/d;0<=h?g<h:g>h;0<=h?g++:g--)g!==this.canvas.height/2/d&&this.canvas.append(new Line(0,g*d+c,this.canvas.width,g*d+c,{stroke:e}));for(f=0,i=this.canvas.width/d;0<=i?f<i:f>i;0<=i?f++:f--)f!==this.canvas.width/2/d&&this.canvas.append(new Line(f*d+b,0,f*d+b,this.canvas.height,{stroke:e}));return this.canvas.append(new Line(0,this.canvas.height/2,this.canvas.width,this.canvas.height/2,{stroke:a})),this.canvas.append(new Line(this.canvas.width/2,0,this.canvas.width/2,this.canvas.height,{stroke:a}))},a}();