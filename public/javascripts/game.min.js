var Action,Brave,Game,MoveAction,SearchAction,Spot,Trifolium,WaitAction,settings,_ref,_ref2,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},__bind=function(a,b){return function(){return a.apply(b,arguments)}};Action=function(){function a(){this.name=null,this.isSucceed=!1,this.time=0}return a.prototype.prepare=function(a){},a.prototype["do"]=function(a){return a.action=null,a.actionProcess=0,a.doneAction(this),this.isSucceed=!1},a.prototype.after=function(a,b){var c;return b.prepare(a),a.action=b,a.destination=(c=b.to)!=null?c:a.spot},a}(),WaitAction=function(a){function b(a){b.__super__.constructor.apply(this,arguments),this.name="wait",this.time=a}return __extends(b,a),b.prototype["do"]=function(a){return b.__super__["do"].call(this,a),this.after(a,a.spot.randomAction()),this.isSucceed=!0},b}(Action),MoveAction=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments),this.name="move",this.from=a,this.to=c,this.time=a.distance(c)*100}return __extends(b,a),b.prototype["do"]=function(a){return b.__super__["do"].call(this,a),a.spot=this.to,this.after(a,this.to.randomAction()),this.isSucceed=!0},b}(Action),SearchAction=function(a){function b(a){b.__super__.constructor.apply(this,arguments),this.name="search",this.treasureDict=a,this.treasure=null,this.time=1e3}return __extends(b,a),b.prototype.probabilityMax=1e3,b.prototype["do"]=function(a){var c,d,e,f,g,h,i,j,k;b.__super__["do"].call(this,a),g=0,k=this.treasureDict;for(h in k)f=k[h],g+=f;if(g>this.probabilityMax)return this.isSucceed=!1;i=function(){var a,b;a=this.treasureDict,b=[];for(h in a)f=a[h],b.push(h);return b}.call(this).sort(function(a,b){return.5-Math.random()}),f=0,e=function(){var a,b,c;c=[];for(a=0,b=i.length;a<b;a++)h=i[a],c.push(f+=this.treasureDict[h]);return c}.call(this),d=Math.random()*this.probabilityMax;for(c=0,j=i.length;c<j;c++)h=i[c],this.treasure==null&&d<e[c]&&(this.treasure=h);return this.isSucceed=this.treasure!=null},b}(Action),typeof exports!="undefined"&&exports!==null&&(exports.Action=Action),typeof exports!="undefined"&&exports!==null&&(exports.WaitAction=WaitAction),typeof exports!="undefined"&&exports!==null&&(exports.MoveAction=MoveAction),typeof exports!="undefined"&&exports!==null&&(exports.SearchAction=SearchAction),Brave=function(){function a(a,b,c){var d,e,f,g,h,i,j,k;this.name=a,c==null&&(c={}),this.listeners=[],this.lv=(d=c.lv)!=null?d:1,this.atk=(e=c.atk)!=null?e:1,this.matk=(f=c.matk)!=null?f:1,this.hp=(g=c.hp)!=null?g:10,this.mp=(h=c.mp)!=null?h:10,this.brave=(i=c.brave)!=null?i:50,this.faith=(j=c.faith)!=null?j:50,this.speed=(k=c.speed)!=null?k:3,this.action=null,this.actionProcess=0,this.spot=b,this.destination=b}return a.prototype.tick=function(){var a;return this.action!=null?(this.actionProcess+=this.action.time>0?this.speed/this.action.time:1,this.actionProcess>=1?a=this.action["do"](this):null):null},a.prototype.addListener=function(a){return this.listeners.push(a)},a.prototype.removeListener=function(a){var b;return this.listeners=function(){var c,d,e,f;e=this.listeners,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b!==a&&f.push(b);return f}.call(this)},a.prototype.doneAction=function(a){var b,c,d,e,f;e=this.listeners,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b.completeBraveAction(this,a));return f},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Brave=Brave),typeof require!="undefined"&&require!==null&&(_ref=require("./action"),Action=_ref.Action,WaitAction=_ref.WaitAction,MoveAction=_ref.MoveAction,SearchAction=_ref.SearchAction),Spot=function(){function a(a,b,c,d){this.name=a,this.posX=b,this.posY=c,d==null&&(d=[]),this.actions=this.makeActions(d)}return a.prototype.randomAction=function(){var a;return a=Math.floor(Math.random()*this.actions.length),this.actions[a]},a.prototype.distance=function(a){return Math.sqrt(Math.pow(this.posX-a.posX,2)+Math.pow(this.posY-a.posY,2))},a.prototype.makeActions=function(a){var b,c,d,e,f;d=[];if(a!=null)for(e=0,f=a.length;e<f;e++){c=a[e],b=null;switch(c.type){case"wait":b=new WaitAction(c.time)}b!=null&&d.push(b)}return d},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Spot=Spot),typeof require!="undefined"&&require!==null&&(Brave=require("./trifolium/brave").Brave,Spot=require("./trifolium/spot").Spot,_ref2=require("./trifolium/action"),Action=_ref2.Action,WaitAction=_ref2.WaitAction,MoveAction=_ref2.MoveAction,SearchAction=_ref2.SearchAction),Trifolium=function(){function a(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;p=a.spotInfoList,i=a.routeInfoList,k=a.spawnSpotName,d=a.braveNameList,this.spotList=function(){var a,b,c;c=[];for(a=0,b=p.length;a<b;a++)o=p[a],c.push(new Spot(o.name,o.posX,o.posY,o.actions));return c}(),this.routeList=[],f=[];for(q=0,u=i.length;q<u;q++)h=i[q],m=this.spotForName(h[0]),n=this.spotForName(h[1]),f.push(new MoveAction(m,n)),f.push(new MoveAction(n,m)),this.routeList.push([m,n]);j=this.spotForName(k),y=this.spotList;for(r=0,v=y.length;r<v;r++){l=y[r];for(s=0,w=f.length;s<w;s++)e=f[s],e.from===l&&l.actions.push(e)}this.braveList=function(){var a,b,c;c=[];for(a=0,b=d.length;a<b;a++)g=d[a],c.push(new Brave(g,j,{speed:Math.floor(Math.random()*50)+20}));return c}(),z=this.braveList;for(t=0,x=z.length;t<x;t++)c=z[t],c.addListener(this),b=c.spot.randomAction(),b.prepare(c),c.action=b,c.destination=(A=b.to)!=null?A:c.spot}return a.prototype.start=function(){var a,b=this;return this.count=0,a=setInterval(function(){return b.tick(),b.count++},30)},a.prototype.tick=function(){var a,b,c,d,e;d=this.braveList,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.tick());return e},a.prototype.completeBraveAction=function(a,b){},a.prototype.spotForName=function(a){var b;return function(){var c,d,e,f;e=this.spotList,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b.name===a&&f.push(b);return f}.call(this)[0]},a}(),typeof exports!="undefined"&&exports!==null&&(exports.Trifolium=Trifolium),settings={spawnSpotName:"castle",spotInfoList:[{name:"townA",posX:20,posY:-60,actions:[{type:"wait",time:3e3}]},{name:"townB",posX:-100,posY:-20,actions:[{type:"wait",time:3e3}]},{name:"townC",posX:20,posY:40,actions:[{type:"wait",time:3e3}]},{name:"dungeonA",posX:120,posY:-80,actions:[{type:"wait",time:3e3}]},{name:"dungeonB",posX:-60,posY:-80,actions:[{type:"wait",time:3e3}]},{name:"dungeonC",posX:-80,posY:60,actions:[{type:"wait",time:3e3}]},{name:"castle",posX:-40,posY:0,actions:[{type:"wait",time:3e3}]},{name:"temple",posX:60,posY:-20,actions:[{type:"wait",time:3e3}]}],routeInfoList:[["townA","dungeonB"],["townA","castle"],["townA","temple"],["townB","dungeonB"],["townB","castle"],["townC","castle"],["townC","temple"],["dungeonA","temple"],["dungeonC","castle"]],braveNameList:["anderson","bob","clarisse","daniel","eric","fredelic","george","heinkel","iris","jennifer","kirby","leonard","michael","nick","orlando","pierre","qian","richard","sara","thomas","ulrich","veeder","walter","xavier","yakov","zach"]},typeof exports!="undefined"&&exports!==null&&(exports.settings=settings),$(function(){var a;return a=new Game,a.start()}),Game=function(){function a(){this.debugMatrix=__bind(this.debugMatrix,this),this.simulator=new Trifolium(settings),this.canvas=new Canvas($("#main-screen").get(0),600,450),this.mapScale=2,this.selectedBrave=null}return a.prototype.appendRoute=function(a){var b,c;return b="rgba(0, 255, 0, 0.2)",c=new Line(this.canvas.width/2+a[0].posX*this.mapScale,this.canvas.height/2+a[0].posY*this.mapScale,this.canvas.width/2+a[1].posX*this.mapScale,this.canvas.height/2+a[1].posY*this.mapScale,{stroke:b,strokeWidth:10*this.mapScale,lineCap:"round"}),this.canvas.append(c)},a.prototype.appendSpot=function(a){var b;return b=new Circle(10*this.mapScale,{id:a.name,x:this.canvas.width/2+a.posX*this.mapScale,y:this.canvas.height/2+a.posY*this.mapScale,stroke:"rgba(0, 0, 255, 1.0)",strokeWidth:this.mapScale,endAngle:Math.PI*2}),this.canvas.append(b)},a.prototype.appendBrave=function(a){var b,c,d,e,f=this;return c=new CanvasNode(3*this.mapScale,{id:a.name,x:this.bravePosX(a),y:this.bravePosY(a)}),c.addFrameListener(function(b,d){return c.x=f.bravePosX(a),c.y=f.bravePosY(a)}),c.addEventListener("mousedown",function(b){return f.selectedBrave=a}),d="hsla("+parseInt(Math.random()*360)+", 70%, 50%, 1.0)",e=new Circle(2*this.mapScale,{x:0,y:-2*this.mapScale,fill:d,endAngle:Math.PI*2}),b=new Rectangle(4*this.mapScale,4*this.mapScale,{x:-2*this.mapScale,y:0,fill:d}),c.append(e),c.append(b),this.canvas.append(c)},a.prototype.displayBraveInfo=function(a){var b,c,d,e,f;d=["name","lv","atk","matk","hp","mp","brave","faith","speed"];for(e=0,f=d.length;e<f;e++)c=d[e],$("#brave-"+c+"-value").text(a[c]);return $("#brave-position-value").text(""+a.spot.name),$("#brave-action-value").text(""+a.action.name),b=(a.actionProcess*100).toFixed(1),$("#brave-actionProcess-bar").text(""+b+"%"),$("#brave-actionProcess-bar").css("width",""+b+"%")},a.prototype.bravePosX=function(a){return this.canvas.width/2+(a.spot.posX+(a.destination.posX-a.spot.posX)*a.actionProcess)*this.mapScale},a.prototype.bravePosY=function(a){return this.canvas.height/2+(a.spot.posY+(a.destination.posY-a.spot.posY)*a.actionProcess)*this.mapScale},a.prototype.prepareDisplayObjects=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=this;l=this.simulator.routeList;for(f=0,i=l.length;f<i;f++)c=l[f],this.appendRoute(c);m=this.simulator.spotList;for(g=0,j=m.length;g<j;g++)e=m[g],this.appendSpot(e);n=this.simulator.braveList;for(h=0,k=n.length;h<k;h++)a=n[h],this.appendBrave(a);return this.debugMatrix(),b=16*this.mapScale,d=new Rectangle(b,b,{rx:4,ry:4,x:-b,y:-b,fill:"rgba(255, 128, 0, 0.3)",stroke:"rgba(255, 128, 0, 0.5)",strokeWidth:this.mapScale,endAngle:Math.PI*2}),d.addFrameListener(function(a,c){if(o.selectedBrave)return d.x=o.bravePosX(o.selectedBrave)-b/2,d.y=o.bravePosY(o.selectedBrave)-b/2}),this.canvas.append(d),this.canvas.addFrameListener(function(a,b){if(o.selectedBrave)return o.displayBraveInfo(o.selectedBrave)})},a.prototype.start=function(){return this.prepareDisplayObjects(),this.simulator.start()},a.prototype.debugMatrix=function(){var a,b,c,d,e,f,g,h,i;d=10*this.mapScale,e="rgba(0, 0, 255, 0.1)",a="rgba(0, 0, 255, 0.5)",b=this.canvas.width%d/2,c=this.canvas.height%d/2;for(g=0,h=this.canvas.height/d;0<=h?g<h:g>h;0<=h?g++:g--)g!==this.canvas.height/2/d&&this.canvas.append(new Line(0,g*d+c,this.canvas.width,g*d+c,{stroke:e}));for(f=0,i=this.canvas.width/d;0<=i?f<i:f>i;0<=i?f++:f--)f!==this.canvas.width/2/d&&this.canvas.append(new Line(f*d+b,0,f*d+b,this.canvas.height,{stroke:e}));return this.canvas.append(new Line(0,this.canvas.height/2,this.canvas.width,this.canvas.height/2,{stroke:a})),this.canvas.append(new Line(this.canvas.width/2,0,this.canvas.width/2,this.canvas.height,{stroke:a}))},a}();